name: Vionix Pipeline

on:
  push:
  schedule:
    - cron: "0 2,5,10,13 * * *"

concurrency:
  group: vionix-pipeline
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"

  GEMENI_KEY: ${{ secrets.GEMENI_KEY }}
  GEMENI_MODEL: ${{ secrets.GEMENI_MODEL }}
  ADJECTIVES: ${{ secrets.ADJECTIVES }}
  THEMES: ${{ secrets.THEMES }}
  LANGUAGE: ${{ secrets.LANGUAGE }}

  S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
  S3_SECRETE_KEY: ${{ secrets.S3_SECRETE_KEY }}
  S3_ZONE: ${{ secrets.S3_ZONE }}
  S3_BUCKET: ${{ secrets.S3_BUCKET }}
  S3_URL: ${{ secrets.S3_URL }}

  FB_VERSION: ${{ secrets.FB_VERSION }}
  FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
  FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}

  INSTA_PAGE_ID: ${{ secrets.INSTA_PAGE_ID }}
  INSTA_PAGE_TOKEN: ${{ secrets.INSTA_PAGE_TOKEN }}

  THREADS_VERSION: ${{ secrets.THREADS_VERSION }}
  THREADS_PAGE_ID: ${{ secrets.THREADS_PAGE_ID }}
  THREADS_PAGE_TOKEN: ${{ secrets.THREADS_PAGE_TOKEN }}

  YT_JSON: ${{ secrets.YT_JSON }}
  JSON_CLIENT_YT: ${{ secrets.JSON_CLIENT_YT }}
  JSON_OAUTH_YT: ${{ secrets.JSON_OAUTH_YT }}

  HF_TOKEN: ${{ secrets.HF_TOKEN }}

  PINTEREST_CLIENT_ID: ${{ secrets.PINTEREST_CLIENT_ID }}
  PINTEREST_CLIENT_SECRET: ${{ secrets.PINTEREST_CLIENT_SECRET }}
  PINTEREST_ACCESS_TOKEN: ${{ secrets.PINTEREST_ACCESS_TOKEN }}
  PINTEREST_BOARD_ID: ${{ secrets.PINTEREST_BOARD_ID }}
  PINTEREST_REFRESH_TOKEN: ${{ secrets.PINTEREST_REFRESH_TOKEN }}
  PINTEREST_API_URL: ${{ secrets.PINTEREST_API_URL }}
  PINTEREST_STATIC_DOMINANT_COLOR: ${{ secrets.PINTEREST_STATIC_DOMINANT_COLOR }}

  VIONIX_GIST_ID: ${{ secrets.VIONIX_GIST_ID }}

jobs:

# -------------------------------------------------
# 1Ô∏è‚É£ SETUP
# -------------------------------------------------
  setup:
    name: üß± Setup Environment
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Prepare pip cache directory
        run: mkdir -p ~/.cache/pip

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: "6.1.0"

# -------------------------------------------------
# 2Ô∏è‚É£ INSTALL
# -------------------------------------------------
  install:
    name: üì¶ Install Dependencies
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Restore pip cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install private Vionix wheel
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          RELEASE_TAG: ${{ secrets.RELEASE_TAG }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          OWNER="simplycodesmart"
          REPO="Vionix"
          API_URL="https://api.github.com/repos/$OWNER/$REPO/releases/tags/$RELEASE_TAG"

          RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" "$API_URL")
          WHEEL_NAME=$(echo "$RESPONSE" | jq -r '.assets[] | select(.name | endswith(".whl")) | .name')

          if [ -z "$WHEEL_NAME" ]; then
            echo "‚ùå No wheel found for tag $RELEASE_TAG"
            exit 1
          fi

          WHEEL_URL=$(echo "$RESPONSE" | jq -r '.assets[] | select(.name == "'$WHEEL_NAME'") | .url')

          curl -L \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/octet-stream" \
            "$WHEEL_URL" \
            -o "$WHEEL_NAME"

          pip install "$WHEEL_NAME"

      - name: Cache private wheel
        uses: actions/cache@v5
        with:
          path: ./*.whl
          key: vionix-wheel-${{ secrets.RELEASE_TAG }}

      - name: Install requirements
        run: pip install -r requirements.txt --prefer-binary

# -------------------------------------------------
# 3Ô∏è‚É£ PREPARE
# -------------------------------------------------
  prepare:
    name: üß© Prepare Assets & Secrets
    runs-on: ubuntu-latest
    needs: install

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Copy assets
        run: |
          cp assets/bg.png .
          cp assets/font_te.ttf .
          cp assets/output_image.png .

# -------------------------------------------------
# 4Ô∏è‚É£ RUN
# -------------------------------------------------
  run:
    name: üöÄ Run Vionix Pipeline
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Restore pip cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

      - name: Restore cached Vionix wheel
        uses: actions/cache@v5
        with:
          path: ./*.whl
          key: vionix-wheel-${{ secrets.RELEASE_TAG }}

      - name: Install Vionix + deps
        run: |
          python -m pip install --upgrade pip
          pip install ./*.whl || true
          pip install -r requirements.txt --prefer-binary

      # üîë REQUIRED AUTH FILES (FIX)
      - name: Create client_secrets.json & oauth.json
        run: |
          python - <<'EOF'
          import json, os

          with open("client_secrets.json", "w") as f:
              json.dump(json.loads(os.environ["JSON_CLIENT_YT"]), f, indent=2)

          with open("oauth.json", "w") as f:
              json.dump(json.loads(os.environ["JSON_OAUTH_YT"]), f, indent=2)

          print("Auth files created successfully")
          EOF

      - name: Pick random music
        id: music
        run: |
          NUM=$((1 + RANDOM % 23))
          echo "num=$NUM" >> $GITHUB_OUTPUT
          cp assets/music/$NUM.mp3 .

      - name: Execute main
        run: python main.py "${{ steps.music.outputs.num }}"
